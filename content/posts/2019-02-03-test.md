---
template: post
title: TestContainersä½¿ã£ã¦ã¿ãªã„ã‹ï¼Ÿ
slug: /posts/test-containers
draft: true
date: 2019-02-02T15:47:47.575Z
description: >-
  ã¿ãªã•ã‚“ã¯ã€DBã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ†ã‚¹ãƒˆã¯ã©ã†æ›¸ã„ã¦ã„ã¾ã™ã‹ï¼ŸDBã‚’ãƒ¢ãƒƒã‚¯ã«ã—ã¦ã„ã¾ã™ã‹ï¼Ÿå®Ÿéš›ã«DBã‚’ç”¨æ„ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã‹ï¼Ÿ 
  ç§ã¯ã€ã ã„ãŸã„H2ã‚’ç”¨ã„ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚H2ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨DDLå•é¡Œã«ç›´é¢ã—ã¦ã—ã¾ã„ã¾ã™ã€‚æœ¬ç•ªã§ã¯MySQLã‚„Postgresã‚’ä½¿ã£ã¦ã„ã‚‹ã¨æ€ã†ã®ã§ã€ãƒ†ã‚¹ãƒˆã®ç‚ºã«DDLã‚’ç”¨æ„ã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚ 
  ã‚ã–ã‚ã–ç”¨æ„ã™ã‚‹ã®ã‚ã‚“ã©ãã•ã„ã¨ã‹ã€ã“ã‚Œã£ã¦æœ¬å½“ã«ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã«ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿã¨ã‹ã®ç–‘å•ã‚’æŒã£ã¦ã„ã¾ã—ãŸã€‚  

  ãã“ã§ã€çŸ¥ã‚Šåˆã£ãŸã®ãŒä»Šå›ç´¹ä»‹ã™ã‚‹TestContainersã§ã™ã€‚

  TestContainersã¯ã€JUnitã®ãƒ†ã‚¹ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹Javaã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€Dockerã‚³ãƒ³ãƒ†ãƒŠä¸Šã§DBã‚„Selenium web
  browserãªã©ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
category: Test
tags:
  - TestContainers
---
ã¿ãªã•ã‚“ã¯ã€DBã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ†ã‚¹ãƒˆã¯ã©ã†æ›¸ã„ã¦ã„ã¾ã™ã‹ï¼ŸDBã‚’ãƒ¢ãƒƒã‚¯ã«ã—ã¦ã„ã¾ã™ã‹ï¼Ÿå®Ÿéš›ã«DBã‚’ç”¨æ„ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã‹ï¼Ÿ  
ç§ã¯ã€ã ã„ãŸã„H2ã‚’ç”¨ã„ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚H2ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨DDLå•é¡Œã«ç›´é¢ã—ã¦ã—ã¾ã„ã¾ã™ã€‚æœ¬ç•ªã§ã¯MySQLã‚„Postgresã‚’ä½¿ã£ã¦ã„ã‚‹ã¨æ€ã†ã®ã§ã€ãƒ†ã‚¹ãƒˆã®ç‚ºã«DDLã‚’ç”¨æ„ã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚  
ã‚ã–ã‚ã–ç”¨æ„ã™ã‚‹ã®ã‚ã‚“ã©ãã•ã„ã¨ã‹ã€ã“ã‚Œã£ã¦æœ¬å½“ã«ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã«ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿã¨ã‹ã®ç–‘å•ã‚’æŒã£ã¦ã„ã¾ã—ãŸã€‚  

ãã“ã§ã€çŸ¥ã‚Šåˆã£ãŸã®ãŒä»Šå›ç´¹ä»‹ã™ã‚‹[TestContainers](https://www.testcontainers.org/)ã§ã™ã€‚
TestContainersã¯ã€JUnitã®ãƒ†ã‚¹ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹Javaã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€Dockerã‚³ãƒ³ãƒ†ãƒŠä¸Šã§DBã‚„Selenium web browserãªã©ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ç´¹ä»‹ã—ã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã§ä½¿ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

```
Java 11
Maven
Spring Boot 2.1.2.RELEASE
Spring Data JPA
Mysql
JUnit 5
TestContainers 1.10.6
```

# TestContainersã‚’ã¨ã‚Šã‚ãˆãšå‹•ã‹ãã†
pom.xmlã«ã¾ãšä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>testcontainers</artifactId>
    <version>1.10.6</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>mysql</artifactId>
    <version>1.10.6</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>1.10.6</version>
    <scope>test</scope>
</dependency>
```

HelloTest.java
```
@Testcontainers
class TestContainersTest {

    @Container
    private static final MySQLContainer MY_SQL_CONTAINER = new MySQLContainer();

    @Test
    void test() {
        assertTrue(MY_SQL_CONTAINER.isRunning());
    }
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æ¬¡ã®ãƒ­ã‚°ãŒå‡ºã¦Docker imageãŒpullã•ã‚ŒãŸå¾Œã«ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚
```
...
00:43:22.656 [main] INFO org.testcontainers.DockerClientFactory - Connected to docker: 
  Server Version: 18.09.1
  API Version: 1.39
  Operating System: Docker for Mac
  Total Memory: 1999 MB
...
00:43:35.506 [main] INFO org.testcontainers.DockerClientFactory - Ryuk started - will monitor and terminate Testcontainers containers on JVM exit
        â„¹ï¸ Checking the system...
        âœ” Docker version should be at least 1.6.0
00:43:35.513 [main] DEBUG com.github.dockerjava.core.command.AbstrDockerCmd - Cmd: 3ff9169b21b876bfc317476f8750851c18881855d46b1ed8a3656354a6f6487a,<null>,true,<null>,<null>,<null>,<null>,{df,-P},com.github.dockerjava.core.exec.ExecCreateCmdExec@a8e6492
00:43:35.610 [tc-okhttp-stream-812143047] DEBUG com.github.dockerjava.core.command.ExecStartResultCallback - STDOUT: Filesystem           1024-blocks    Used Available Capacity Mounted on
overlay               65792556   2810704  59610076   5% /
tmpfs                    65536         0     65536   0% /dev
tmpfs                  1023516         0   1023516   0% /sys/fs/cgroup
/dev/sda1             65792556   2810704  59610076   5% /etc/resolv.conf
/dev/sda1             65792556   2810704  59610076   5% /etc/hostname
/dev/sda1             65792556   2810704  59610076   5% /etc/hosts
shm                      65536         0     65536   0% /dev/shm
tmpfs                   204704       568    204136   0% /run/docker.sock
tmpfs                  1023516         0   1023516   0% /proc/acpi
tmpfs                    65536         0     65536   0% /proc/kcore
tmpfs                    65536         0     65536   0% /proc/keys
tmpfs                    65536         0     65536   0% /proc/timer_list
tmpfs                    65536         0     65536   0% /proc/sched_debug
tmpfs                  1023516         0   1023516   0% /sys/firmware
        âœ” Docker environment should have more than 2GB free disk space
...
00:46:59.144 [main] DEBUG ğŸ³ [mysql:5.7.22] - Starting container: mysql:5.7.22
00:46:59.144 [main] DEBUG ğŸ³ [mysql:5.7.22] - Trying to start container: mysql:5.7.22
00:46:59.145 [main] DEBUG ğŸ³ [mysql:5.7.22] - Trying to start container: mysql:5.7.22 (attempt 1/3)
00:46:59.145 [main] DEBUG ğŸ³ [mysql:5.7.22] - Starting container: mysql:5.7.22
00:46:59.145 [main] INFO ğŸ³ [mysql:5.7.22] - Creating container for image: mysql:5.7.22
...
00:47:13.432 [ducttape-1] INFO ğŸ³ [mysql:5.7.22] - Obtained a connection to container (jdbc:mysql://localhost:32769/test)
00:47:13.434 [main] INFO ğŸ³ [mysql:5.7.22] - Container mysql:5.7.22 started
00:47:13.467 [main] DEBUG com.github.dockerjava.core.command.AbstrDockerCmd - Cmd: 7b65dc2dfe7e4bd414d9bf228e5b5a004d1045ed05d1cf01b203fba38a5a7c31,false,com.github.dockerjava.core.exec.InspectContainerCmdExec@77602954
00:47:13.468 [main] DEBUG com.github.dockerjava.core.exec.InspectContainerCmdExec - GET: OkHttpWebTarget(okHttpClient=org.testcontainers.shaded.okhttp3.OkHttpClient@6941827a, baseUrl=http://docker.socket/, path=[/containers/7b65dc2dfe7e4bd414d9bf228e5b5a004d1045ed05d1cf01b203fba38a5a7c31/json], queryParams={})
00:47:13.479 [main] DEBUG com.github.dockerjava.core.command.AbstrDockerCmd - Cmd: 7b65dc2dfe7e4bd414d9bf228e5b5a004d1045ed05d1cf01b203fba38a5a7c31,<null>,com.github.dockerjava.core.exec.KillContainerCmdExec@73c60324
00:47:14.088 [main] DEBUG com.github.dockerjava.core.command.AbstrDockerCmd - Cmd: 7b65dc2dfe7e4bd414d9bf228e5b5a004d1045ed05d1cf01b203fba38a5a7c31,false,com.github.dockerjava.core.exec.InspectContainerCmdExec@71ae31b0
00:47:14.088 [main] DEBUG com.github.dockerjava.core.exec.InspectContainerCmdExec - GET: OkHttpWebTarget(okHttpClient=org.testcontainers.shaded.okhttp3.OkHttpClient@6941827a, baseUrl=http://docker.socket/, path=[/containers/7b65dc2dfe7e4bd414d9bf228e5b5a004d1045ed05d1cf01b203fba38a5a7c31/json], queryParams={})
00:47:14.099 [main] DEBUG com.github.dockerjava.core.command.AbstrDockerCmd - Cmd: 7b65dc2dfe7e4bd414d9bf228e5b5a004d1045ed05d1cf01b203fba38a5a7c31,true,true,com.github.dockerjava.core.exec.RemoveContainerCmdExec@2c7d121c
00:47:14.151 [main] DEBUG org.testcontainers.utility.ResourceReaper - Removed container and associated volume(s): mysql:5.7.22Class transformation time: 0.043640464s for 3142 classes or 1.3889390197326542E-5s per class
```

[ã“ã“](https://www.testcontainers.org/features/configuration/)ã‚’è¦‹ã¦ã‚‚ã‚‰ãˆã°ã‚ã‹ã‚‹ã®ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ã‚³ãƒ³ãƒ†ãƒŠãŒæ­£ã—ãèµ·å‹•ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ã—ã‹ã—ã€ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã®ã§ãƒ†ã‚¹ãƒˆçµ‚äº†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚
testcontainers.propertiesã‚’ç½®ã„ã¦ã€ã€€`checks.disable=false` ã‚’è¨­å®šã™ã‚‹ã¨ã“ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã®ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œãªããªã‚Šã¾ã™ã€‚

# Repositoryã®ãƒ†ã‚¹ãƒˆæ›¸ã„ã¦ã¿ã‚ˆã†
ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ï¼ˆBrandRepository.javaï¼‰

```
@Repository
public interface BrandRepository extends JpaRepository<Brand, Integer> {
    List<Brand> findAllByGender(Brand.Gender gender);
}
```

ãƒ†ã‚¹ãƒˆç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆapplication.propertiesï¼‰
```
spring.datasource.url=jdbc:tc:mysql:5.7.22://hostname:port/test?TC_MY_CNF=db/mysql_conf_override
spring.datasource.driver-class-name=org.testcontainers.jdbc.ContainerDatabaseDriver
spring.datasource.username=test
spring.datasource.password=
spring.datasource.sql-script-encoding=utf-8

spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=true
```

MySQLã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’UTF-8ã«å¤‰æ›´ã—ãŸã„ã®ã§ã€`spring.datasource.url`ã§TC_MY_CNFãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§`somepath/mysql_conf_override`ã‚’è¨­å®šã—ã¾ã™ã€‚`somepath/mysql_conf_override`ã®ä¸‹ã«ã‚ã‚‹*.cnfãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã‚Œã¾ã™ã€‚  
ä»Šå›ã¯ã€db/mysql_conf_override/custom.cnfã«`character-set-server = utf8`ã ã‘ã‚’æ›¸ãã¾ã—ãŸã€‚

ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ï¼ˆBrandRepositorTest.javaï¼‰
```
@Testcontainers
@DataJpaTest(excludeAutoConfiguration = AutoConfigureTestDatabase.class)
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class BrandRepositoryTest {

    @Autowired
    private BrandRepository brandRepository;

    @Test
    @Sql(scripts = "classpath:/db/migration/brand/initial_data.sql")
    void findByGender() {
		    Assertions.assertThat(brandRepository.findAllByGender(Brand.Gender.MAN))
                .extracting(Brand::getName, Brand::getDesigner, Brand::getGender)
                .containsExactly(Tuple.tuple("ETHOSENS", "æ©‹æœ¬ å”¯", Brand.Gender.MAN));
    }
}
```

`@DataJpaTest` ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§H2ã‚’ä½¿ã†ã®ã§ã€ãã®è¨­å®šãŒã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ ã“ã‚Œã§èµ·å‹•ã™ã‚‹ã¨ã€application.propertiesã®è¨­å®šãŒä½¿ã‚ã‚Œã¦ã€Dockerä¸Šã«èµ·å‹•ã—ãŸMySQLãŒä½¿ã‚ã‚Œã¾ã™ã€‚


TestContainersã‚’ä½¿ã†ã“ã¨ã§æœ¬ç•ªã¨åŒã˜DBã‚’ç°¡å˜ã«ç”¨æ„ã§ãã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯å°‘ãªã„ã®ã§ï¼‘æ™‚é–“åŠã‚‚ã‚ã‚Œã°å…¨éƒ¨èª­ã¿åˆ‡ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ä»Šå›ç´¹ä»‹ã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã€[GitHub](https://github.com/b1a9id/test-containers-sandbox)ã«ç½®ã„ã¦ã„ã¾ã™ã€‚
